<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <title>Werewolf Lobby</title>
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body>
  <div id="app"></div>

  <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
  <script th:inline="javascript">
    // ----- bootstrap -----
    // later, read it:     
    /*<![CDATA[*/
    const initial_lobby = /*[[${lobby}]]*/;
    const player_id = /*[[${player_id}]]*/;
    /*]]>*/
    const room_id = initial_lobby.room_id; // field names match your LobbyView record
    const host_id = initial_lobby.host_id;
    const token = document.querySelector('meta[name="_csrf"]').content;
    const header = document.querySelector('meta[name="_csrf_header"]').content;

    // skeleton HTML (no Thymeleaf loops now)
    const app = document.getElementById('app');
    app.innerHTML = `
      <h1>Room code: <span id="room-code"></span></h1>
      <p>Host: <span id="host-id"></span></p>
      <h2 id="game-status"></h2>
      <p>Participants:</p>
      <ul id="participants"></ul>
      <div id="host-actions"></div>
    `;
    console.log(app.innerHTML);

    function start_counter({ endAtMs, onTick, intervalMs = 1000 }) {
      let id = null;

      function tick() {
        const remaining = Math.max(0, endAtMs - Date.now());
        onTick(remaining);
        if (remaining === 0) stop(); // auto-stop on finish
      }

      id = setInterval(tick, intervalMs);
      tick(); // run immediately

      function stop() {
        if (id !== null) { clearInterval(id); id = null; }
      }
      return stop;
    }
    let stop_counter = null;

    // render functions
    function render_lobby(lobby) {
      // Stop any ongoing counters before rendering something else
      if (stop_counter != null) {
        stop_counter();
      }
      document.getElementById('room-code').textContent = lobby.room_id;
      document.getElementById('host-id').textContent = lobby.host_id;

      const ul = document.getElementById('participants');
      ul.innerHTML = '';
      lobby.players.forEach(p => {
        const li = document.createElement('li');
        if (p.id === player_id) {
          const span_ready_text = '✅ Ready';
          const span_not_ready_text = '❌ Not Ready' + (player_id === host_id ? " (click to start the game)" : "");
          const span_text = p.ready ? span_ready_text : span_not_ready_text;
          li.innerHTML = `
            <span>${escape_html(p.nickname)}</span>
            <button class="ready-btn" data-ready="${p.ready}">
              <span>${span_text}</span>
            </button>
          `;
        } else {
          li.innerHTML = `
            <span>${escape_html(p.nickname)}</span>
            <span> ${p.ready ? '✅ Ready' : '❌ Not Ready'}</span>
          `;
        }
        ul.appendChild(li);
      });

      // wire handlers for the single current-player button (if present)
      const btn = ul.querySelector('.ready-btn');
      if (btn) {
        btn.onclick = async () => {
          const current = btn.getAttribute('data-ready') === 'true';
          const next = !current;
          // optimistic
          btn.setAttribute('data-ready', String(next));
          btn.querySelector('span').textContent = next ? '✅ Ready' : '❌ Not Ready';
          try {
            const res = await fetch(`/room/${room_id}/players/${player_id}/ready`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', [header]: token },
              body: JSON.stringify({ ready: next })
            });
            if (!res.ok) {
              // revert
              btn.setAttribute('data-ready', String(current));
              btn.querySelector('span').textContent = current ? '✅ Ready' : '❌ Not Ready';
              console.error('Toggle failed', res.status, await res.text());
            }
          } catch (e) {
            btn.setAttribute('data-ready', String(current));
            btn.querySelector('span').textContent = current ? '✅ Ready' : '❌ Not Ready';
            console.error(e);
          }
        };
      }

      const status = document.getElementById('game-status');
      if (lobby.status === 'LOBBY') {
        status.textContent = 'Game has not started yet';
      } else if (lobby.status === 'COUNTDOWN') {
        status.textContent = 'Game is starting in ';
        const lobby_countdown_timer = document.createElement('span');
        lobby_countdown_timer.innerText = '000';
        lobby_countdown_timer.id = 'lobby-countdown-timer';
        status.appendChild(lobby_countdown_timer);
        running_counter = true;
        const server_time     = Date.parse(lobby.server_now);
        const server_deadline = Date.parse(lobby.deadline);
        const current_time    = Date.now();
        stop_counter = start_counter({
          endAtMs: server_deadline,
          onTick: (ms) => {lobby_countdown_timer.innerText = (Math.ceil(ms/1000))}
        })
      } else {
        console.assert(lobby.status === 'RUNNING');
        window.location.href = `../game/${room_id}`;
        status.textContent = "Game is running";
      }
    }

    function escape_html(s) {
      return String(s).replaceAll('&', '&amp;').replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;').replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // initial render
    render_lobby(initial_lobby);

    // ----- websocket wiring -----
    const wsUrl = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws';
    const client = new StompJs.Client({
      brokerURL: wsUrl,
      reconnectDelay: 1000,
      heartbeatIncoming: 10000,
      heartbeatOutgoing: 10000,
      debug: (s) => console.log('[STOMP]', s),
      onConnect: () => {
        client.subscribe(`/topic/room.${room_id}.lobby`, (msg) => render_lobby(JSON.parse(msg.body)));
        client.subscribe(`/topic/room.${room_id}.events`, (msg) => {/* handleEvent(JSON.parse(msg.body)) */ });
        client.subscribe(`/topic/room.${room_id}.game`, (msg) => {/* renderGame(JSON.parse(msg.body))  */ });
      }
    });
    client.activate();
  </script>
</body>

</html>